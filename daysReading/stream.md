# 流处理

这里可以是广义的数据处理，比如音视频、TCP连接、消息队列，表示无界限的数据。

- 事件(Event)
- 消息(message)

## 消息系统

消息系统根据传递消息的实体分为两类：
- 直接生产者向消费者传递消息，比如发送TCP/UDP请求，使用HTTP/GRPC协议。
- 通过消息中间件、消息队列来传递消息。

直接消息传递：
- UDP组播
- 各语言的消息库、SDK
- 基于webhook回调

消息系统中在消费者不足的情况下：
- 系统丢消息
- 消息放入缓存队列（内存不足如何？落盘？）
- 背压，阻塞生产者

多消费者传递消息：
- 负载均衡，传给其中一个消费者
- 扇出（fan-out），传给下游所有消费者

## 日志

### 系统数据同步

系统数据同步方法：
- 双写（dual write）：分布式事务，最常见的比如缓存和数据库，用的就是双写
- 变更数据捕获（CDC）：通过数据库内部日志同步到其他系统，mysql的binlog,mongo的oplog

## 变更数据捕获

衍生数据系统：将数据从一个数据库同步到另外各种数据库

涉及到的技术：
- 同步技术：数据库触发器，解析复制日志
- 快照：将变更数据转换成状态数据节约磁盘空间
- 日志压缩：设置墓碑，加垃圾回收

关于状态和事件流有趣的理解：
- 状态是事件流的积分结果
- 事件流是状态的微分结果

命令查询责任分离：放弃了一致性，将数据的写入形式和读取形式相分离，以获得灵活性。

## 流处理

流处理：
- 复合事件处理：匹配状态机，查询是固定的，数据不断流入各种查询模式。
- 流分析

物化视图(materialized view)：创建一份聚合统计的缓存数据，并保持和底层数据一致。

流处理特性：
无界 -> 如何定义时间？事件时间/处理时间 -> 没有准确的时间概念如何容错（仅有效执行一次）

解决 exactly-once 的方法：
- 微批处理+存档点
- 原子性提交（分布式事务）
- 幂等性，将原来不是幂等的操作变成幂等可以通过版本号或者偏移量的方法


时间窗口类型：
- 滚动窗口：不重叠
- 跳动窗口：可以重叠也可以不重叠，根据步长跳动到下一个起始点
- 滑动窗口：步长为时间1个单位的跳动窗口，能保证在步长范围内的两个数据可以被一个窗口找到

流式连接：
- 流流连接（窗口连接）
- 流表连接（数据库对流数据进行扩展）
- 表表连接（维护物化视图）

